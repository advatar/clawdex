# Clawdex Kline Agent Backend

This document defines how `clawdex` (Rust runtime in `clawdex/clawdex/`) can manage Kline as an agent backend without changing `openclaw`.

## Scope

- Runtime: `clawdex` daemon/gateway.
- Out of scope: OpenClaw TypeScript runtime changes.
- Goal: route `agent:<id>:...` sessions to either:
  - local Codex runner (default), or
  - external Kline backend (`kind: "kline"`).

## Backend Contract (v1)

`clawdex` calls Kline over HTTP:

- `POST {klineBaseUrl}/v1/agent/turn`
- Auth: optional `Authorization: Bearer <token>`

Request payload:

```json
{
  "agentId": "kline",
  "sessionKey": "agent:kline:telegram:group-1",
  "message": "User input text"
}
```

Response payload (accepted forms):

```json
{
  "ok": true,
  "message": "Assistant response text",
  "warnings": ["optional warning"]
}
```

Also accepted:

- `result.message`
- `response`
- `text`

## Clawdex Config

`~/.codex/clawdex/config.json5`:

```json5
{
  agents: {
    default_agent_id: "main",
    backends: {
      kline: {
        kind: "kline",
        url: "http://127.0.0.1:18888",
        tokenEnv: "KLINE_BACKEND_TOKEN",
        timeoutMs: 30000
      }
    }
  }
}
```

Notes:

- `default_agent_id` is used for non-namespaced session keys (for example `telegram:+123`).
- If backend config is missing/invalid, clawdex falls back to Codex backend.

## Session Routing Rules

1. Session key parsing:
   - `agent:<id>:...` -> target backend for `<id>`
   - non-namespaced key -> `agents.default_agent_id` (or `main`)
2. If `<id>` maps to `kind: "kline"`, clawdex dispatches to Kline HTTP backend.
3. Otherwise, clawdex uses local Codex runner.

## Migration Plan

1. Configure Kline backend in clawdex config.
2. Start Kline agent endpoint (`/v1/agent/turn`) on local network.
3. Send inbound payloads with `agentId: "kline"` to clawdex gateway `/v1/incoming`.
4. Verify session keys become `agent:kline:<channel>:<from>`.
5. Verify daemon responses are generated by Kline backend.
6. Roll out channel/account bindings gradually by setting `agentId` at ingress.

## Required Checklist

1. Configure `agents.backends.kline` in `~/.codex/clawdex/config.json5`.
2. Send inbound messages with `agentId: "kline"` to clawdex gateway `/v1/incoming`.
3. Daemon will dispatch those `agent:kline:*` sessions to Kline backend automatically.

## Validation Checklist

- `POST /v1/incoming` with `agentId: "kline"` persists namespaced session key.
- Daemon run logs show Kline backend calls for `agent:kline:*`.
- `POST /v1/incoming` without `agentId` still uses default Codex flow.
- Failure mode: Kline 4xx/5xx returns explicit daemon error (no silent fallback).
